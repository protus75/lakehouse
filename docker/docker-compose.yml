version: '3.8'

services:

  # ── PostgreSQL ──────────────────────────────────────────────
  # Backend database for the Polaris Iceberg catalog
  postgres:
    image: postgres:15
    container_name: lakehouse-postgres
    environment:
      POSTGRES_DB: polaris
      POSTGRES_USER: polaris
      POSTGRES_PASSWORD: polaris_secret
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U polaris"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ── SeaweedFS ───────────────────────────────────────────────
  # Distributed object storage with S3-compatible API
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: lakehouse-weed-master
    ports:
      - "9333:9333"
    command: "master -ip=seaweedfs-master -ip.bind=0.0.0.0"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 10

  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: lakehouse-weed-volume
    ports:
      - "8080:8080"
    command: "volume -mserver=seaweedfs-master:9333 -ip.bind=0.0.0.0 -dir=/data -dataCenter=dc1"
    depends_on:
      seaweedfs-master:
        condition: service_healthy
    volumes:
      - ../storage:/data

  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: lakehouse-weed-filer
    ports:
      - "8898:8898"
    command: "filer -master=seaweedfs-master:9333 -port=8898"
    depends_on:
      seaweedfs-master:
        condition: service_healthy

  seaweedfs-s3:
    image: chrislusf/seaweedfs:latest
    container_name: lakehouse-weed-s3
    ports:
      - "8333:8333"
    command: "s3 -filer=seaweedfs-filer:8898 -port=8333 -config=/etc/seaweedfs/s3.json"
    depends_on:
      - seaweedfs-filer
    volumes:
      - ./s3.json:/etc/seaweedfs/s3.json

  # ── Apache Polaris ──────────────────────────────────────────
  # REST catalog for Apache Iceberg tables
  # Note: verify the image tag at https://github.com/apache/polaris
  polaris:
    image: apache/polaris:latest
    container_name: lakehouse-polaris
    ports:
      - "8181:8181"
    environment:
      QUARKUS_DATASOURCE_DB_KIND: postgresql
      QUARKUS_DATASOURCE_USERNAME: polaris
      QUARKUS_DATASOURCE_PASSWORD: polaris_secret
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/polaris
      POLARIS_PERSISTENCE_TYPE: relational-jdbc
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/api/management/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 20

  # ── Python Workspace ────────────────────────────────────────
  # Jupyter Lab + all Python tools (dlt, dbt, Streamlit, etc.)
  workspace:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lakehouse-workspace
    ports:
      - "8889:8889"    # Jupyter Lab
      - "8501:8501"    # Streamlit
    volumes:
      - ../data:/workspace/data
      - ../dlt:/workspace/dlt
      - ../dbt:/workspace/dbt
      - ../streamlit:/workspace/streamlit
      - ../chroma_db:/workspace/chroma_db
      - workspace_db:/workspace/db    # DuckDB persistent storage
    environment:
      S3_ENDPOINT: http://seaweedfs-s3:8333
      S3_ACCESS_KEY: lakehouse_key
      S3_SECRET_KEY: lakehouse_secret
      POLARIS_URI: http://polaris:8181/api/catalog
    command: >
      jupyter lab
      --ip=0.0.0.0
      --port=8889
      --no-browser
      --allow-root
      --NotebookApp.token=''
      --NotebookApp.password=''
      --notebook-dir=/workspace
    depends_on:
      polaris:
        condition: service_healthy

volumes:
  postgres_data:
  workspace_db:

networks:
  default:
    name: lakehouse-network